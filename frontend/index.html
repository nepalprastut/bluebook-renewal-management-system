<script>
  // 1. THE AUTH GUARD (Run this immediately)
  function checkAuth() {
    const role = sessionStorage.getItem("role");
    if (!role || role !== "OWNER") {
      // replace() ensures the "index.html" is removed from history 
      // so the user can't "Go Back" to it.
      window.location.replace("login.html");
    }
  }
  checkAuth();

  // 2. THE LOGOUT FUNCTION
  function logout() {
    sessionStorage.clear();
    // replace() is key here to prevent back-button access
    window.location.replace("login.html");
  }

  // 3. CACHE BUSTER (Prevents the browser from loading a "snapshot" of the page)
  window.onpageshow = function(event) {
    if (event.persisted) {
      window.location.reload();
    }
  };
</script>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vehicle List</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .logout-btn {
      margin-left: auto;
      background: #ff4d4d;
      color: white !important;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logout-btn:hover { background: #ff3333; }
  </style>
</head>
<body>

<nav>
  <h2>Bluebook Renewal</h2>
  <a href="index.html" class="active"><i class="fas fa-car"></i> Vehicles</a>
  <a href="renewals.html"><i class="fas fa-history"></i> Renewal History</a>
  <a href="javascript:void(0)" onclick="logout()" class="logout-btn">
    <i class="fas fa-sign-out-alt"></i> Logout
  </a>
</nav>

<main>
  <header>
    <h1>Registered Vehicles</h1>
    <a href="add_vehicle.html" class="btn-add">Add Vehicle</a>
  </header>

  <div class="stats-grid">
    <div class="stat-card"><h3>Total Vehicles</h3><p id="totalCount">0</p></div>
    <div class="stat-card"><h3>Active</h3><p id="activeCount" style="color: var(--success)">0</p></div>
    <div class="stat-card"><h3>Expired</h3><p id="alertCount" style="color: var(--danger)">0</p></div>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Owner</th>
          <th>Plate No</th>
          <th>Type</th>
          <th>Expiry Date</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="vehicleTable"></tbody>
    </table>
  </div>
</main>

<script>
const user_id = sessionStorage.getItem("user_id");

async function loadVehicles() {
  try {
    const res = await fetch(`/api/owner/vehicles?user_id=${user_id}`);
    const data = await res.json();

    const table = document.getElementById("vehicleTable");
    table.innerHTML = "";

    let total = data.length, active = 0, expired = 0;

    data.forEach(v => {
      if (v.status === 'ACTIVE') active++;
      if (v.status === 'EXPIRED') expired++;

      table.innerHTML += `
        <tr>
          <td>${v.full_name || "N/A"}</td>
          <td>${v.plate_no}</td>
          <td>${v.vehicle_type}</td>
          <td>${v.expiry_date ? v.expiry_date.split("T")[0] : "N/A"}</td>
          <td><span class="status-pill ${v.status}">${v.status || "PENDING"}</span></td>
        </tr>
      `;
    });

    document.getElementById("totalCount").innerText = total;
    document.getElementById("activeCount").innerText = active;
    document.getElementById("alertCount").innerText = expired;
  } catch (err) {
    console.error("Error loading vehicles:", err);
  }
}
loadVehicles();
</script>
</body>
</html>